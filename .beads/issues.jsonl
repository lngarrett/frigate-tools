{"id":"frigate-tools-04g","title":"Add debug logging for invalid skip_hours values","description":"parse_skip_hours() silently ignores invalid hour values like '18-24' (hour 24 is out of range 0-23). Users may not realize their filter isn't being applied. Add structlog debug message when invalid ranges are encountered to aid troubleshooting.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-06T14:17:55.093070256-05:00","updated_at":"2025-12-06T14:26:20.433630846-05:00","closed_at":"2025-12-06T14:26:20.433630846-05:00","dependencies":[{"issue_id":"frigate-tools-04g","depends_on_id":"frigate-tools-9eh","type":"blocks","created_at":"2025-12-06T14:18:13.773323895-05:00","created_by":"daemon"}]}
{"id":"frigate-tools-0a1","title":"Fix timezone handling: assume local time input, convert to UTC for file matching","description":"## Problem\n\nFrigate stores recordings using UTC timestamps in the directory structure:\n```\n/recordings/YYYY-MM-DD/HH/camera/MM.SS.mp4\n```\nWhere HH is the UTC hour.\n\nThe CLI currently accepts naive datetime inputs and compares them directly against these UTC paths. This means:\n- User inputs `--start \"2025-12-07 11:00\"` (intending 11 AM local)\n- CLI finds files from UTC 11:00\n- But UTC 11:00 = 6 AM EST (5 hours off!)\n\n## Solution\n\nAssume all time inputs are **local time** and convert to UTC internally for file matching.\n\n### Implementation\n\n1. In `cli.py`, after parsing datetime args, convert to UTC:\n```python\nfrom datetime import timezone\nimport time\n\ndef local_to_utc(dt: datetime) -\u003e datetime:\n    \"\"\"Convert naive local datetime to UTC.\"\"\"\n    # Get local timezone offset\n    if time.daylight:\n        utc_offset = -time.altzone\n    else:\n        utc_offset = -time.timezone\n    \n    # Add timezone info and convert\n    local_tz = timezone(timedelta(seconds=utc_offset))\n    return dt.replace(tzinfo=local_tz).astimezone(timezone.utc).replace(tzinfo=None)\n```\n\n2. Apply conversion to `start` and `end` before passing to `generate_file_lists()`\n\n3. Update help text to clarify times are interpreted as local time\n\n## Testing\n\n- Test with known local time and verify correct UTC files are found\n- Test across DST boundaries if applicable\n- Test with times near midnight (date boundary edge case)","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-07T11:24:08.778531399-05:00","updated_at":"2025-12-07T11:28:12.099110399-05:00","closed_at":"2025-12-07T11:28:12.099110399-05:00"}
{"id":"frigate-tools-2io","title":"Clip file selection and concatenation","description":"Find segments overlapping time range from Frigate recordings. Concat with -c copy (default, fast) or reencode if requested. Reuse file list logic from timelapse module. Tests with mock directory structure.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-06T14:02:13.222286397-05:00","updated_at":"2025-12-06T14:22:37.785742405-05:00","closed_at":"2025-12-06T14:22:37.785742405-05:00","dependencies":[{"issue_id":"frigate-tools-2io","depends_on_id":"frigate-tools-9eh","type":"blocks","created_at":"2025-12-06T14:05:31.0648634-05:00","created_by":"daemon"}]}
{"id":"frigate-tools-2ip","title":"Clip multi-camera output","description":"Multi-camera clip support. Default: grid layout (reuse grid module from timelapse). Option --separate for individual files per camera. Sync timestamps across cameras.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-06T14:02:18.319830875-05:00","updated_at":"2025-12-06T14:22:48.343437364-05:00","closed_at":"2025-12-06T14:22:48.343437364-05:00","dependencies":[{"issue_id":"frigate-tools-2ip","depends_on_id":"frigate-tools-2io","type":"blocks","created_at":"2025-12-06T14:05:31.109811952-05:00","created_by":"daemon"},{"issue_id":"frigate-tools-2ip","depends_on_id":"frigate-tools-485","type":"blocks","created_at":"2025-12-06T14:05:31.121215551-05:00","created_by":"daemon"}]}
{"id":"frigate-tools-3pz","title":"Fix Frigate directory structure - date/hour/camera not camera/date/hour","description":"file_list.py assumes recordings are stored as: recordings/camera/YYYY-MM-DD/HH/MM.SS.mp4\n\nBut actual Frigate structure is: recordings/YYYY-MM-DD/HH/camera/MM.SS.mp4\n\nThis causes 'No recording files found' error. Need to update find_recording_files() to use the correct path structure: instance_path/recordings/date_dir/hour_dir/camera/filename instead of instance_path/recordings/camera/date_dir/hour_dir/filename","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-12-06T14:30:07.619632543-05:00","updated_at":"2025-12-06T14:32:54.92911649-05:00","closed_at":"2025-12-06T14:32:54.92911649-05:00"}
{"id":"frigate-tools-3s3","title":"Timelapse CLI interface","description":"Typer CLI: frigate-tools timelapse --cameras bporchcam,frontcam --start 2025-12-01T08:00 --end 2025-12-05T16:00 --duration 5m --skip-days sat,sun --skip-hours 16-8 -o output.mp4. Wire up all components. Auto-detect instance from available paths.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-06T13:58:05.889102225-05:00","updated_at":"2025-12-06T14:22:03.756666472-05:00","closed_at":"2025-12-06T14:22:03.756666472-05:00","dependencies":[{"issue_id":"frigate-tools-3s3","depends_on_id":"frigate-tools-485","type":"blocks","created_at":"2025-12-06T14:05:31.086688927-05:00","created_by":"daemon"},{"issue_id":"frigate-tools-3s3","depends_on_id":"frigate-tools-9eh","type":"blocks","created_at":"2025-12-06T14:05:31.098602311-05:00","created_by":"daemon"}]}
{"id":"frigate-tools-485","title":"Multi-camera grid layout","description":"Auto-calculate optimal grid dimensions (2 cams = 1x2, 3-4 = 2x2, 5-6 = 2x3, etc). Use ffmpeg filter_complex with xstack for tiling. Sync file lists across cameras and handle gaps where one camera may have missing segments.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-06T13:57:59.839018623-05:00","updated_at":"2025-12-06T14:18:13.801111569-05:00","closed_at":"2025-12-06T14:18:13.801111569-05:00","dependencies":[{"issue_id":"frigate-tools-485","depends_on_id":"frigate-tools-d4r","type":"blocks","created_at":"2025-12-06T14:05:31.074671456-05:00","created_by":"daemon"}]}
{"id":"frigate-tools-48e","title":"Report hardware/software encoding mode to user during timelapse","description":"During timelapse creation, show the user whether hardware acceleration (VAAPI/QSV) or software encoding is being used. This helps users know if they need to add themselves to video/render groups for faster encoding.","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-06T15:59:27.289371931-05:00","updated_at":"2025-12-06T16:09:37.044552595-05:00","closed_at":"2025-12-06T16:09:37.044552595-05:00"}
{"id":"frigate-tools-77o","title":"Fix timelapse concatenation hanging on large file counts","description":"","status":"closed","priority":0,"issue_type":"epic","created_at":"2025-12-06T17:22:21.110701425-05:00","updated_at":"2025-12-06T17:25:17.287629579-05:00","closed_at":"2025-12-06T17:25:17.287629579-05:00"}
{"id":"frigate-tools-77o.1","title":"Create a reproducible test case for the hanging concatenation","description":"Create a script that generates a large number of small, empty video files to reliably reproduce the hanging concatenation issue without depending on real user data. This will provide a consistent test bed for debugging.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-06T17:22:29.36200099-05:00","updated_at":"2025-12-06T17:23:54.695011111-05:00","closed_at":"2025-12-06T17:23:54.695011111-05:00","dependencies":[{"issue_id":"frigate-tools-77o.1","depends_on_id":"frigate-tools-77o","type":"parent-child","created_at":"2025-12-06T17:22:29.362582159-05:00","created_by":"daemon"}]}
{"id":"frigate-tools-77o.2","title":"Verify the batch concatenation fix","description":"Using the reproducible test case, verify that the existing batch concatenation implementation in concat_files successfully resolves the hanging issue. If it does not, debug and refine the batching logic until it works.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-06T17:22:33.944398102-05:00","updated_at":"2025-12-06T17:24:33.076041527-05:00","closed_at":"2025-12-06T17:24:33.076041527-05:00","dependencies":[{"issue_id":"frigate-tools-77o.2","depends_on_id":"frigate-tools-77o","type":"parent-child","created_at":"2025-12-06T17:22:33.945009001-05:00","created_by":"daemon"}]}
{"id":"frigate-tools-77o.3","title":"Fix the progress bar for batch concatenation","description":"Implement accurate, file-count-based progress reporting for the batch concatenation process in concat_files and cli.py. The progress bar should reflect the number of files processed out of the total, providing a clear and correct user experience.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-06T17:22:40.747298586-05:00","updated_at":"2025-12-06T17:25:09.97112362-05:00","closed_at":"2025-12-06T17:25:09.97112362-05:00","dependencies":[{"issue_id":"frigate-tools-77o.3","depends_on_id":"frigate-tools-77o","type":"parent-child","created_at":"2025-12-06T17:22:40.747868438-05:00","created_by":"daemon"}]}
{"id":"frigate-tools-7uu","title":"Encoding gets stuck on large files - BOTH select AND setpts approaches fail","description":"","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-12-06T15:27:07.452817341-05:00","updated_at":"2025-12-06T16:07:38.088208419-05:00","closed_at":"2025-12-06T16:07:38.088208419-05:00","dependencies":[{"issue_id":"frigate-tools-7uu","depends_on_id":"frigate-tools-ell","type":"blocks","created_at":"2025-12-06T15:27:12.07198498-05:00","created_by":"daemon"}],"comments":[{"id":2,"issue_id":"frigate-tools-7uu","author":"logan","text":"## UPDATE: Both approaches have been tried and BOTH fail\n\n### Attempt 1: select filter (commit 01e4e11)\nCommand: -vf select='not(mod(n,360))',setpts=N/(30.0*TB)\n- Gets stuck at ~39% through 22GB file (8.6GB read)\n- High CPU (500%+) but no I/O progress\n\n### Attempt 2: setpts filter (commit a619293)\nCommand: -vf setpts=PTS/360.55\n- Gets stuck at ~32% through 22GB file (7.1GB read)\n- Same symptoms: high CPU, frozen I/O\n\n### Common pattern\nBoth freeze at 30-40% through file. ffmpeg uses 500-600% CPU but no read/write progress.\n\n### What needs to be tried\n1. Skip concat - process source segments directly\n2. Parallel segment processing\n3. Chunked processing - split into smaller pieces\n4. Hardware acceleration (QSV available on this system)\n\n### Test case\nInput: 6 hours (2160 files, 21GB), Target: 60s timelapse\n","created_at":"2025-12-06T20:48:18Z"},{"id":3,"issue_id":"frigate-tools-7uu","author":"logan","text":"DO NOT CLOSE - BUG NOT FIXED. Both select and setpts filters freeze at 30-40% through 22GB file. Tested live, fails every time. Must remain OPEN until 6-hour timelapse completes successfully.\n","created_at":"2025-12-06T20:56:00Z"}]}
{"id":"frigate-tools-7zx","title":"Add rich progress bars for CLI operations","description":"","status":"closed","priority":3,"issue_type":"feature","created_at":"2025-12-06T15:01:31.169918861-05:00","updated_at":"2025-12-06T15:08:38.190142424-05:00","closed_at":"2025-12-06T15:08:38.190142424-05:00"}
{"id":"frigate-tools-8nc","title":"Optimize timelapse encoding pipeline with full hardware acceleration","description":"## Problem\n\nCurrent timelapse encoding only uses hardware for the final encoding step, while decoding and filtering run on CPU. This causes severe performance bottlenecks:\n\n- **Current performance**: 3 minutes to encode 1 hour of footage (240x speedup)\n- **CPU usage**: 548% (5.5 cores maxed out)\n- **Bottleneck**: CPU decoding + CPU setpts filter processing all frames\n\n### Current Pipeline\n```\nInput (3.6GB) → CPU Decode → CPU setpts filter → CPU format conversion → GPU upload → GPU Encode → Output (40MB)\n```\n\n### Issues\n1. No hardware decoding - reading 3.6GB H.264 on CPU\n2. setpts filter processes ALL frames on CPU (108k frames to output 450 frames)\n3. format=nv12 + hwupload copies every frame CPU→GPU\n4. Inefficient for high speedup ratios (240x)\n\n## Proposed Solution\n\n### Option 1: Full Hardware Pipeline (VAAPI)\n```python\n# src/frigate_tools/timelapse.py:446-455\nelif hwaccel == HWAccel.VAAPI:\n    input_fps = output_fps / speed\n    cmd.extend([\n        \"-hwaccel\", \"vaapi\",\n        \"-hwaccel_output_format\", \"vaapi\",\n        \"-hwaccel_device\", \"/dev/dri/renderD128\",\n        \"-i\", str(input_path),\n        \"-vf\", f\"fps={output_fps}/{speed},scale_vaapi=format=nv12\",\n        \"-c:v\", \"h264_vaapi\",\n        \"-qp\", \"23\",\n    ])\n```\n\n### Option 2: Frame Selection (More Efficient)\nFor extreme speedups, use select filter to process only needed frames.\n\n### Option 3: Direct Frame Extraction\nSkip concat step for 100x+ speedups, extract frames directly from source files.\n\n## Expected Performance\n- **Target**: \u003c30 seconds for 1 hour of footage (10x improvement)\n- **CPU usage**: \u003c100% (90% reduction)\n- **Full GPU pipeline**: Decode → Filter → Encode all on GPU\n\n## Testing Requirements\n\n### 1. Performance Benchmarks\n- [ ] Measure encode time for 1 hour timelapse (before/after)\n- [ ] Measure CPU usage during encode (before/after)\n- [ ] Measure GPU encoder utilization (should be \u003e0%)\n- [ ] Test multiple speedup ratios: 10x, 60x, 240x, 1000x\n\n### 2. Quality Validation\n- [ ] Compare output quality (visual inspection)\n- [ ] Verify output duration matches target duration\n- [ ] Verify output framerate matches requested fps\n- [ ] Check for frame drops or artifacts\n\n### 3. Hardware Compatibility\n- [ ] Test with VAAPI (Intel QSV)\n- [ ] Test fallback to software encoding if hw fails\n- [ ] Verify detection logic still works\n\n### 4. Edge Cases\n- [ ] Test with various source framerates (5fps, 10fps, 30fps)\n- [ ] Test with different resolutions\n- [ ] Test with corrupted/missing frames in source\n- [ ] Test very short timelapses (10 seconds source)\n- [ ] Test very long timelapses (24+ hours source)\n\n### 5. Regression Testing\n- [ ] Existing timelapse tests still pass\n- [ ] Multi-camera grid timelapses work\n- [ ] Calendar filtering still works\n- [ ] Progress reporting accurate\n\n## Implementation Notes\n\nFile: `src/frigate_tools/timelapse.py`\n- Lines 446-455: Update VAAPI encoding command\n- Lines 433-445: Consider similar updates for QSV\n- Consider adding benchmark/profiling output for testing\n\n## Success Criteria\n- 10x faster encoding for typical use cases\n- \u003c100% CPU usage during encode\n- GPU encoder utilization \u003e0%\n- All tests pass\n- No quality degradation","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-07T09:52:30.846646531-05:00","updated_at":"2025-12-07T09:58:35.525582149-05:00","closed_at":"2025-12-07T09:58:35.525582149-05:00"}
{"id":"frigate-tools-9eh","title":"File list generation with calendar filtering","description":"Input: cameras[], start, end, instance, skip_days[], skip_hours[]. Parse Frigate directory structure (YYYY-MM-DD/HH/camera/MM.SS.mp4). Filter out specified days (e.g., sat,sun) and hours (e.g., 16-8 meaning skip 4pm to 8am). Output: sorted list of files per camera.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-06T13:57:50.057834623-05:00","updated_at":"2025-12-06T14:14:31.853575671-05:00","closed_at":"2025-12-06T14:14:31.853575671-05:00","dependencies":[{"issue_id":"frigate-tools-9eh","depends_on_id":"frigate-tools-hgp","type":"blocks","created_at":"2025-12-06T14:05:31.044063671-05:00","created_by":"daemon"}]}
{"id":"frigate-tools-9j8","title":"Add integration test for generate_file_lists with combined filters","description":"test_file_list.py has good unit test coverage but no integration test that exercises generate_file_lists() with BOTH skip_days AND skip_hours applied simultaneously. Add a test case that verifies the combination works correctly (e.g., skip weekends AND skip overnight hours).","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-06T14:17:56.105871662-05:00","updated_at":"2025-12-06T14:24:47.421764908-05:00","closed_at":"2025-12-06T14:24:47.421764908-05:00","dependencies":[{"issue_id":"frigate-tools-9j8","depends_on_id":"frigate-tools-9eh","type":"blocks","created_at":"2025-12-06T14:18:14.438725662-05:00","created_by":"daemon"}]}
{"id":"frigate-tools-d4r","title":"Single camera timelapse encoding","description":"Two-step approach: concat copy to temp file, then encode with setpts filter. Calculate speed multiplier from source duration / target duration. Defaults: fast preset, native resolution. Include ffmpeg progress parsing for output.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-06T13:57:54.443612512-05:00","updated_at":"2025-12-06T14:18:26.959240024-05:00","closed_at":"2025-12-06T14:18:26.959240024-05:00","dependencies":[{"issue_id":"frigate-tools-d4r","depends_on_id":"frigate-tools-9eh","type":"blocks","created_at":"2025-12-06T14:05:31.054569863-05:00","created_by":"daemon"}]}
{"id":"frigate-tools-dvq","title":"Commit existing frigate-tools work to git","description":"Git log shows commits from a different project (rover). All frigate-tools code (scaffolding, observability, file_list, tests) has not been committed. This is critical - work could be lost. Need to: git add the src/, tests/, pyproject.toml, etc. and commit.","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-06T14:17:54.345726503-05:00","updated_at":"2025-12-06T14:20:39.966840117-05:00","closed_at":"2025-12-06T14:20:39.966840117-05:00"}
{"id":"frigate-tools-edl","title":"Implement keyframe-only timelapse extraction (no concat)","description":"## Problem\n\nCurrent timelapse encoding is fundamentally inefficient:\n- Uses `select` filter which **decodes ALL frames** before discarding\n- 1 hour → 15 seconds: Decodes 108,000 frames to keep 450\n- 1 month → 15 seconds: Would decode 77 million frames to keep 450\n- Creates massive intermediate concat files (86GB+ for long timelapses)\n\n## Key Insight\n\n**Keyframe-only extraction is sufficient for ALL timelapse scenarios.**\n\nFrigate recordings have ~1 keyframe per second. For keyframe-only at 30fps output, speedup must be ≥30x. Real timelapse use cases always exceed this:\n\n| Source | Output | Speedup | Works? |\n|--------|--------|---------|--------|\n| 1 hour | 2 min | 30x | ✅ |\n| 1 hour | 15 sec | 240x | ✅ |\n| 1 day | 5 min | 288x | ✅ |\n| 1 month | 15 sec | 172,800x | ✅ |\n\n## Solution: Direct Keyframe Extraction\n\n**Single unified approach - no tiers, no concat:**\n\n```python\ndef create_timelapse(files, target_duration, output_fps=30):\n    frames_needed = int(target_duration * output_fps)\n    total_duration = len(files) * 5.0  # Frigate 5-sec segments\n    interval = total_duration / frames_needed\n    \n    # Calculate which timestamps/files we need\n    timestamps = [i * interval for i in range(frames_needed)]\n    frame_sources = [(files[int(ts/5)], ts % 5) for ts in timestamps]\n    \n    # Extract keyframes directly using -skip_frame nokey\n    # Only decodes keyframes, not all frames!\n    extract_and_encode(frame_sources, output_path, hwaccel)\n```\n\n## Why This Is Fast\n\n**Before:** `concat(720 files) → decode(108k frames) → select(450) → encode`\n**After:** `calculate(450 positions) → extract(450 keyframes) → encode`\n\n- Only decodes 450 keyframes (not 108,000 frames)\n- No intermediate concat file (0GB vs 86GB)\n- Direct seeks to needed timestamps\n\n## Expected Performance\n\n| Scenario | Current | New | Improvement |\n|----------|---------|-----|-------------|\n| 1 hour → 15 sec | 3 min | ~5 sec | **36x faster** |\n| 1 day → 5 min | ~1 hour | ~30 sec | **120x faster** |\n| 1 month → 15 sec | 36+ hours | ~1 min | **2000x faster** |\n\n## Implementation\n\n1. Add `extract_keyframes_for_timelapse()` function\n2. Calculate frame positions → map to source files\n3. Extract keyframes with `-skip_frame nokey -ss {offset}`\n4. Pipe to hardware encoder (VAAPI/QSV)\n5. Replace current concat+encode approach\n\n## Files to Modify\n\n- `src/frigate_tools/timelapse.py` - New implementation\n- `tests/test_timelapse.py` - Update tests\n\n## Success Criteria\n\n- Month-long timelapses in ~1 minute (not 36 hours)\n- No intermediate concat files\n- Works with hardware acceleration","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-07T10:35:14.77413115-05:00","updated_at":"2025-12-07T10:52:04.646083192-05:00","closed_at":"2025-12-07T10:52:04.646083192-05:00"}
{"id":"frigate-tools-ell","title":"Add end-to-end test with real Frigate recordings","description":"","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-06T15:27:03.16217405-05:00","updated_at":"2025-12-06T15:30:12.719331287-05:00","closed_at":"2025-12-06T15:30:12.719331287-05:00"}
{"id":"frigate-tools-exa","title":"Add CLI unit tests for parse_duration and find_frigate_instance","description":"test_cli.py only has 4 tests checking help output. Missing tests for: parse_duration() with various formats (5m, 1h30m, invalid), find_frigate_instance() with mocked paths, and timelapse_create command invocation with mocked dependencies.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-06T14:20:28.76081911-05:00","updated_at":"2025-12-06T14:23:29.250754264-05:00","closed_at":"2025-12-06T14:23:29.250754264-05:00"}
{"id":"frigate-tools-hgp","title":"OTel instrumentation infrastructure","description":"Core observability layer. opentelemetry-sdk, opentelemetry-exporter-otlp, structlog with trace context injection. Decorator/context manager pattern so features get o11y for free. Config via env vars (OTEL_EXPORTER_OTLP_ENDPOINT, OTEL_SERVICE_NAME, etc). Defaults to localhost:4317. Traces for operations, metrics for performance, structured logs. Must be baked into scaffolding.","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-06T14:02:07.914978916-05:00","updated_at":"2025-12-06T14:12:25.694490721-05:00","closed_at":"2025-12-06T14:12:25.694490721-05:00","dependencies":[{"issue_id":"frigate-tools-hgp","depends_on_id":"frigate-tools-pjp","type":"blocks","created_at":"2025-12-06T14:05:31.028863892-05:00","created_by":"daemon"}]}
{"id":"frigate-tools-i6v","title":"Fix tracing depth - CLI missing parent spans","description":"**Problem**\nAll traced spans appear flat/top-level instead of nested hierarchy.\n\n**Root Cause**\nCLI (cli.py) has no traced_operation calls. Each module function (generate_file_lists, create_timelapse, concat_files, etc.) creates its own root span since there's no CLI-level parent span active when they're called.\n\n**Evidence**\n- grep 'traced_operation' on cli.py returns no matches\n- Module functions correctly use traced_operation\n- Child spans within a function ARE nested (e.g., concat_files is child of create_timelapse)\n- But top-level operations from CLI are all siblings\n\n**Fix**\nAdd traced_operation calls in CLI that wrap each command's workflow:\n- timelapse command: wrap with traced_operation('timelapse_create')\n- clip command: wrap with traced_operation('clip_create')\n- etc.\n\nThis creates the parent span that all module-level operations will attach to.","status":"open","priority":2,"issue_type":"bug","created_at":"2025-12-07T11:26:41.811712801-05:00","updated_at":"2025-12-07T11:26:50.976734997-05:00"}
{"id":"frigate-tools-ijo","title":"Performance testing for timelapse generation approaches","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-06T13:33:20.764011153-05:00","updated_at":"2025-12-06T13:48:05.095168329-05:00","closed_at":"2025-12-06T13:48:05.095168329-05:00"}
{"id":"frigate-tools-llw","title":"Multi-camera timelapse ignores target_duration","description":"cli.py:297-301 calls create_grid_video() for multi-camera output but doesn't pass target_duration. The grid video is created at full speed instead of being time-lapsed. Need to either: (1) add timelapse encoding to create_grid_video, or (2) create grid first then apply timelapse encoding as a second step.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-06T14:20:27.963204842-05:00","updated_at":"2025-12-06T14:23:19.929064998-05:00","closed_at":"2025-12-06T14:23:19.929064998-05:00","dependencies":[{"issue_id":"frigate-tools-llw","depends_on_id":"frigate-tools-3s3","type":"blocks","created_at":"2025-12-06T14:20:33.431522919-05:00","created_by":"daemon"}]}
{"id":"frigate-tools-pjp","title":"Project scaffolding - Python project with uv, typer CLI framework, basic structure with timelapse subcommand","description":"Python project setup with uv, typer CLI framework, pytest. Basic CLI structure with timelapse subcommand. Include test infrastructure from the start - all code must have corresponding tests.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-06T13:57:45.008430669-05:00","updated_at":"2025-12-06T14:10:01.077159982-05:00","closed_at":"2025-12-06T14:10:01.077159982-05:00"}
{"id":"frigate-tools-q33","title":"Move tempfile import to module level in grid.py","description":"grid.py:207 has 'import tempfile' inside create_grid_video(). Should be at module level for consistency with other imports. Functionally fine but inconsistent style.","status":"closed","priority":3,"issue_type":"chore","created_at":"2025-12-06T14:19:51.034682537-05:00","updated_at":"2025-12-06T14:24:46.373792793-05:00","closed_at":"2025-12-06T14:24:46.373792793-05:00"}
{"id":"frigate-tools-sjz","title":"Add dry-run mode with size estimates and disk space check","description":"","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-06T15:01:30.399135934-05:00","updated_at":"2025-12-06T15:04:19.812980944-05:00","closed_at":"2025-12-06T15:04:19.812980944-05:00"}
{"id":"frigate-tools-szd","title":"Fix observability: traces not reaching Datadog due to batch processor","description":"## Problem\n\nfrigate-tools traces are not appearing in Datadog despite:\n- OTLP receiver configured and listening on localhost:4317 ✅\n- Successful gRPC connection from app to collector ✅\n- Traces being created with proper context ✅\n- Other long-running apps successfully sending traces ✅\n\n**Root Cause**: CLI uses `BatchSpanProcessor` which batches spans for efficiency, but short-lived CLI commands exit before the batch is sent to the collector. The `atexit.register(shutdown_observability)` hook doesn't give enough time for async export.\n\n## Evidence\n\n1. **Test with sync export works**: When testing with `init_observability(sync_export=True)`, traces include proper context:\n   ```json\n   {\"trace_id\": \"951613ab1c92e98da2384265ce6d632a\", \"span_id\": \"309f8a4a77a8f6c5\"}\n   ```\n\n2. **No frigate-tools traces in Datadog agent logs**: Only `service.name:agent` traces visible, no `service.name:frigate-tools`\n\n3. **Short-lived process issue**: CLI commands finish in seconds/minutes, process exits before BatchSpanProcessor flushes\n\n## Current Implementation\n\n**src/frigate_tools/observability.py:86-88**\n```python\nprocessor = (\n    SimpleSpanProcessor(exporter) if sync_export else BatchSpanProcessor(exporter)\n)\n```\n\n**src/frigate_tools/cli.py:44-45**\n```python\ninit_observability()  # Uses BatchSpanProcessor by default\natexit.register(shutdown_observability)\n```\n\n## Solution\n\nUse `SimpleSpanProcessor` for CLI applications to ensure immediate export:\n\n```python\n# src/frigate_tools/cli.py:44\ninit_observability(sync_export=True)  # Force synchronous export for CLI\n```\n\n**Why this works:**\n- SimpleSpanProcessor exports spans immediately (synchronous)\n- BatchSpanProcessor batches for efficiency (async, good for long-running services)\n- CLI tools are short-lived, need immediate export\n- Long-running services benefit from batching, CLIs don't\n\n## Testing Plan\n\n1. **Verify traces reach Datadog**:\n   - [ ] Run timelapse command with fix applied\n   - [ ] Check Datadog agent logs for `service.name:frigate-tools`\n   - [ ] Verify traces appear in Datadog UI\n   - [ ] Confirm trace context in structured logs\n\n2. **Test trace content**:\n   - [ ] Verify span names match operation names\n   - [ ] Check attributes are present (file_count, duration, etc.)\n   - [ ] Confirm nested spans show parent/child relationships\n   - [ ] Validate timing information is accurate\n\n3. **Test both commands**:\n   - [ ] `frigate-tools timelapse create` - verify concat and encode spans\n   - [ ] `frigate-tools clip create` - verify clip creation spans\n   - [ ] Multi-camera operations - verify grid spans\n\n4. **Performance check**:\n   - [ ] Ensure synchronous export doesn't significantly slow down commands\n   - [ ] Verify no blocking on network issues (check timeout behavior)\n\n## Success Criteria\n\n- Traces from frigate-tools appear in Datadog APM\n- All operations (concat, encode, grid) are traced\n- Trace context properly injected into structured logs\n- No significant performance degradation\n- Error traces properly marked with error status\n\n## Related\n\nThis is a common pattern for OpenTelemetry CLI applications - see:\n- https://opentelemetry.io/docs/specs/otel/trace/sdk/#shutdown\n- https://github.com/open-telemetry/opentelemetry-python/issues/1718","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-07T10:11:40.563093817-05:00","updated_at":"2025-12-07T10:16:46.197382362-05:00","closed_at":"2025-12-07T10:16:46.197382362-05:00"}
{"id":"frigate-tools-vit","title":"CLI progress spinner shows wrong phase during timelapse creation","description":"","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-06T15:14:30.300509946-05:00","updated_at":"2025-12-06T15:16:13.257837593-05:00","closed_at":"2025-12-06T15:16:13.257837593-05:00"}
{"id":"frigate-tools-x9r","title":"Test infrastructure setup","description":"Set up pytest with fixtures for test data. Create mock Frigate directory structure for testing. Include sample video segments for integration tests. Ensure all modules have corresponding test files.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-06T13:58:42.785601436-05:00","updated_at":"2025-12-06T13:58:53.224417378-05:00","closed_at":"2025-12-06T13:58:53.224417378-05:00"}
{"id":"frigate-tools-xew","title":"Add integration test for timelapse encoding with real video files","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-06T14:56:18.313417083-05:00","updated_at":"2025-12-06T14:58:49.761438385-05:00","closed_at":"2025-12-06T14:58:49.761438385-05:00","dependencies":[{"issue_id":"frigate-tools-xew","depends_on_id":"frigate-tools-xla","type":"blocks","created_at":"2025-12-06T14:56:24.264486523-05:00","created_by":"daemon"}]}
{"id":"frigate-tools-xla","title":"Timelapse encoding too slow for large inputs - needs frame sampling","description":"Encoding 7 hours of footage (25GB concat file) to 60s timelapse took 13+ minutes and appeared stuck. The setpts filter requires decoding every frame of the source video, which is extremely slow for large inputs.\n\nOptions to fix:\n1. Add frame sampling (select every Nth frame) instead of setpts\n2. Use -r to set output framerate and let ffmpeg skip frames\n3. Add a 'select' filter: select='not(mod(n,420))' to only process 1 in 420 frames\n4. Add timeout/progress estimation to detect stuck encodes","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-06T14:53:17.894890294-05:00","updated_at":"2025-12-06T14:56:52.593192025-05:00","closed_at":"2025-12-06T14:56:52.593192025-05:00"}
{"id":"frigate-tools-xya","title":"Review timelapse.py progress callback stdout handling","description":"timelapse.py:213-216 reads from process.stdout in a loop then calls process.communicate(). This works because the iterator consumes the stream, but the pattern is fragile. If stdout isn't fully consumed before communicate(), it could hang. Consider using communicate() with timeout or restructuring to avoid potential race condition.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-06T14:19:51.872498548-05:00","updated_at":"2025-12-06T14:25:28.576180717-05:00","closed_at":"2025-12-06T14:25:28.576180717-05:00"}
{"id":"frigate-tools-yct","title":"Clip CLI interface","description":"frigate-tools clip --cameras bporchcam,frontcam --start 2025-12-01T12:00 --end 2025-12-01T12:05 --separate -o output.mp4. Also support --duration 5m as alternative to --end. Wire up file selection, concat, and grid modules.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-06T14:02:23.580546185-05:00","updated_at":"2025-12-06T14:23:56.820153989-05:00","closed_at":"2025-12-06T14:23:56.820153989-05:00","dependencies":[{"issue_id":"frigate-tools-yct","depends_on_id":"frigate-tools-2ip","type":"blocks","created_at":"2025-12-06T14:05:31.131690907-05:00","created_by":"daemon"}]}
